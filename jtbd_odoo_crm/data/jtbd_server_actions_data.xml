<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- Server Action: Python Code to Log Job Evolution -->
        <record id="server_action_log_job_evolution" model="ir.actions.server">
            <field name="name">JTBD - Code: Log Job Evolution</field>
            <field name="model_id" ref="crm.model_crm_lead"/>
            <field name="state">code</field>
            <field name="code">
# Log the trigger
log(f"JTBD Evolution Triggered for Lead: {record.name} (ID: {record.id}) due to update.")
try:
    # Prepare more detailed state descriptions if possible
    # Use write_date for previous state approximation if available
    # prev_state_desc = f"Snapshot Before Update (Approx): Stage={record.stage_id.name}, Category={record.jtbd_job_category}" # Difficult to get pre-update state reliably here
    prev_state_desc = f"State before current update trigger."
    new_state_desc = f"Current State: Stage={record.stage_id.name}, Category={record.jtbd_job_category}, Statement Excerpt='{record.jtbd_job_statement[:100] if record.jtbd_job_statement else ''}...'"
    now_aware_utc = datetime.datetime.now(timezone('UTC'))
    now_naive_utc = now_aware_utc.replace(tzinfo=None)
    # Create the evolution record
    evo_vals = {
        'lead_id': record.id,
        'change_date': now_naive_utc, # Use the naive UTC datetime
        'previous_state_description': prev_state_desc,
        'new_state_description': new_state_desc,
        'transition_trigger': 'Lead Fields Updated (Stage, Statement, Category, Quadrant)',
        'user_id': env.user.id,
    }
    new_evo = env['jtbd.job.evolution'].create(evo_vals)
    log(f"Created jtbd.job.evolution record {new_evo.id} for Lead {record.id}")
    # --- Phase 4 Placeholder: Trigger external analysis? ---
    # Example: Send data to n8n for deeper evolution pattern detection
    # payload = {'evolution_id': new_evo.id, 'lead_data': record.read([...fields...])[0]}
    # log(f"Simulating webhook call for Job Evolution: {payload}")
    # --- End Placeholder ---
except Exception as e:
    log(f"Error creating Job Evolution record for Lead {record.id}: {e}", level='error')
            </field>
        </record>

        <!-- Server Action: Python Code to Log Content Alignment Check -->
        <record id="server_action_log_content_alignment_check" model="ir.actions.server">
            <field name="name">JTBD - Code: Log Content Alignment Check</field>
            <field name="model_id" ref="crm.model_crm_lead"/>
            <field name="state">code</field>
            <field name="code">
if record and record.jtbd_content_approval_state in ('approved', 'rejected', 'pending_review'):
    log(f"JTBD Content Alignment Check Triggered for Lead: {record.name} (ID: {record.id}). Approval State: {record.jtbd_content_approval_state}")
    msg = f"Content Approval State changed to '{record.jtbd_content_approval_state}'. Review Content Alignment scores and potentially trigger content updates."
    record.message_post(body=msg, subtype_id=env.ref('mail.mt_note').id)
    # --- Phase 4 Placeholder: Trigger external Content Brain action ---
    # Example: Tell Content Brain to re-evaluate alignment or update status
    # payload = {'lead_id': record.id, 'approval_state': record.jtbd_content_approval_state}
    # log(f"Simulating webhook call for Content Approval State change: {payload}")
    # --- End Placeholder ---
else:
    log(f"JTBD Content Alignment Check Skipped for Lead: {record.name} (State: {record.jtbd_content_approval_state})")
            </field>
        </record>
        <!-- Server Action: Python Code to Simulate Webhook -->
        <record id="server_action_simulate_webhook_force_analysis" model="ir.actions.server">
            <field name="name">JTBD - Code: Simulate Webhook on Force Analysis Update</field>
            <field name="model_id" ref="jtbd_odoo_crm.model_jtbd_force_analysis"/>
            <field name="state">code</field>
            <field name="code">
# Simulate calling an external webhook (e.g., n8n) when key scores change
if record:
    log(f"JTBD Webhook Triggered: Force Analysis {record.name} (ID: {record.id}) updated.")
    # Prepare a more realistic payload
    payload = {
        'source': 'odoo_jtbd_force_analysis_update',
        'analysis_id': record.id,
        'analysis_name': record.name,
        'lead_id': record.lead_id.id,
        'lead_name': record.lead_id.name,
        'timestamp_utc': datetime.datetime.now(timezone('UTC')).isoformat() + 'Z',
        'scores': {
            'momentum': record.momentum_score,
            'signal': record.signal_strength,
            'push': record.push_score,
            'pull': record.pull_score,
            'anxiety': record.anxiety_score,
            'habit': record.habit_score,
        },
        'trigger_window': record.trigger_window,
        'intensity': record.intensity_score,
        'contract_loss': record.contract_loss,
        'updated_by_user_id': env.user.id
    }
    # Basic validation before logging/sending
    if not payload.get('lead_id'):
         log(f"Skipping webhook simulation for FA {record.id}: Missing Lead ID.", level='warning')
    else:
        log(f"Simulated Webhook Payload Prepared: {payload}")
        # --- Phase 4: Placeholder for actual HTTP POST request ---
        # webhook_url = env['ir.config_parameter'].sudo().get_param('jtbd_odoo_crm.force_analysis_webhook_url')
        # if webhook_url:
        #    try:
        #        # import requests # Would need this library installed
        #        # headers = {'Content-Type': 'application/json'}
        #        # response = requests.post(webhook_url, headers=headers, json=payload, timeout=10)
        #        # response.raise_for_status() # Check for HTTP errors
        #        log(f"Simulated successful POST to webhook for FA {record.id}")
        #    except Exception as e:
        #        log(f"Simulated webhook POST FAILED for FA {record.id}: {e}", level='error')
        # else:
        #    log("Webhook URL not configured. Skipping actual call.", level='warning')
        # --- End Placeholder ---
        # Add chatter message indicating trigger
        record.message_post(body=f"Force Analysis update detected. Simulated trigger sent.", subtype_id=env.ref('mail.mt_note').id)
else:
    log("Webhook simulation skipped: No record found.", level="warning")
            </field>
        </record>

        <!-- Server Action: Simulate Triggering AI Personalization -->
        <record id="server_action_trigger_ai_personalization" model="ir.actions.server">
            <field name="name">JTBD - Code: Trigger AI Personalization Suggestion</field>
            <field name="model_id" ref="crm.model_crm_lead"/>
            <field name="state">code</field>
            <field name="code">
# Available variables: env, model, records, record, log, ...
if record:
    log(f"JTBD Placeholder Trigger: AI Personalization generation requested for Lead {record.id} - {record.name}.")
    # --- Phase 4: Prepare context ---
    context_data = {'lead_id': record.id, 'job_category': record.jtbd_job_category, 'job_statement': record.jtbd_job_statement, 'force_momentum': record.jtbd_momentum_score, 'outcome_metric': record.jtbd_outcome_metric}
    log(f"Simulated context for AI personalization: {context_data}")
    # --- Phase 4: Call external n8n/AI endpoint ---
    # response = call_external_service(context_data)
    # result_text = process_response(response)
    result_text = "AI Suggestion: Focus on ROI impact based on outcome metric '%s'." % record.jtbd_outcome_metric if record.jtbd_outcome_metric else "AI Suggestion: Emphasize alignment with strategic goals."
    # --- Phase 4: Update Odoo field ---
    # record.write({'jtbd_ai_personalized_messaging_angles': result_text}) # Uncomment when ready
    record.message_post(body=f"AI Personalization Triggered (Simulated). Suggestion: {result_text}", subtype_id=env.ref('mail.mt_note').id)
            </field>
        </record>
    </data>
</odoo>